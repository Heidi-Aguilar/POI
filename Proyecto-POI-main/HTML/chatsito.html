<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuinielaZo - Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@200&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../CSS/Styles.css">
</head>

<body>
    <header>
        <div class="head">
            <div class="logo"><a href="index.html"><img src="../Resources/Imagenes/QuinielazoLogo.png" alt="logo"></a>
            </div>
            <div class="navbar">
                <a href="QuinielaZo.html">Torneo</a>
                <a href="chatsito.html">Chat</a>
                <a href="recompensas.html">Recompensas</a>
                <a href="Novedades.html">Novedades</a>
                <a href="perfil.html">Perfil</a>
            </div>
        </div>
    </header>

    <section class="screen" id="chats">
        <div class="chatwrap">

            <div class="card chatlist">
                <h3>
                    Chats y Usuarios
                    <div class="controls-container">
                        <label for="status-toggle">Activo</label>
                        <label class="switch">
                            <input type="checkbox" id="status-toggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </h3>
                <div id="chatListContainer">
                </div>
            </div>

            <div class="card" id="chatpane">
                <div class="chatbar">
                    <span id="chatTitle">Chat Global</span>
                    <button id="callButton" style="display:none; margin-left: 10px;">üìû Llamar</button>
                </div>


                <div id="chatContent" style="display: flex; flex-direction: column; flex: 1;">
                    <div id="messages">
                    </div>

                    <form id="chatForm">
                        <div class="controls-container">
                            <label for="encryption-toggle">Encriptar</label>
                            <label class="switch" style="width: 38px; height: 22px;">
                                <input type="checkbox" id="encryption-toggle">
                                <span class="slider"></span>
                            </label>
                        </div>

                        <button type="button" id="filePickerButton">üìé</button>
                        <input type="file" id="fileInput" style="display: none;" />

                        <button type="button" id="locationButton">üìç</button>

                        <input id="chatInput" placeholder="Escribe un mensaje‚Ä¶" autocomplete="off" />
                        <button type="submit">Enviar</button>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <footer>
        <div class="footerLinks">
            <a href="#">Contacto</a>
            <a href="#">Aviso de Privacidad</a>
            <a href="#">T√©rminos y Condiciones</a>
        </div>
        <div class="copyright">
            <p>¬© 2026 QuinielaZo. Todos los derechos reservados.</p>
        </div>
    </footer>

    <script type="module">
        import { io } from 'https://cdn.socket.io/4.3.2/socket.io.esm.min.js';

        const IP_LOCAL = "172.20.10.2";
        const SERVER_URL = window.location.hostname === "localhost"
            ? "http://localhost:3000"
            : `http://${IP_LOCAL}:3000`;

        const socket = io(SERVER_URL);
        const MAX_FILE_SIZE = 10 * 1024 * 1024;

        const myName = localStorage.getItem('usuario');
        const myId = localStorage.getItem('userId');

        // Estado del chat
        let currentChatId = 1;
        let currentChatName = 'Chat Global';
        let currentRecipientId = null;
        let onlineUsers = [];

        const chatListContainer = document.getElementById('chatListContainer');
        const messagesDiv = document.getElementById('messages');
        const chatTitle = document.getElementById('chatTitle');
        const encryptionToggle = document.getElementById('encryption-toggle');
        const fileInput = document.getElementById('fileInput');
        const filePickerButton = document.getElementById('filePickerButton');

        const chatForm = document.getElementById('chatForm');
        const chatInput = document.getElementById('chatInput');

        // ELEMENTOS DE CONTROL
        const statusToggle = document.getElementById('status-toggle');
        const locationButton = document.getElementById('locationButton');


        if (!myName || !myId) {
            alert("Inicia sesi√≥n primero.");
            window.location.href = "../HTML/inicio.html";
            throw new Error("Usuario no autenticado.");
        }

        // =========================================================
        // 1. CONEXI√ìN Y ESTADO (ACTIVO/INACTIVO)
        // =========================================================

        socket.on('connect', () => {
            console.log('Conectado a Socket.IO');
            if (statusToggle.checked) {
                socket.emit('user connected', myId);
            }
        });

        socket.on('online users', (userIds) => {
            onlineUsers = userIds.map(id => parseInt(id));
            cargarUsuarios();
        });

        // --- MANEJO DEL SWITCH DE ESTADO ---
        statusToggle.addEventListener('change', () => {
            const isActive = statusToggle.checked;
            if (isActive) {
                socket.emit('user connected', myId);
            } else {
                socket.emit('manual disconnect', myId);
            }
        });


        // =========================================================
        // 2. L√ìGICA DE COMPARTIR UBICACI√ìN (CORREGIDO)
        // =========================================================

        locationButton.addEventListener('click', () => {
            if (!navigator.geolocation) {
                alert('Tu navegador no soporta la geolocalizaci√≥n.');
                return;
            }

            // Deshabilitar bot√≥n para feedback visual
            locationButton.disabled = true;

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;

                    // 1. Generar la URL de Google Maps para compartir (q=<lat>,<lon>)
                    // NOTA: Usar el formato de coordenadas que Google Maps entiende
                    const googleMapsUrl = `https://maps.google.com/?q=${lat},${lon}`;

                    // 2. Crear el mensaje especial reconocido por el backend: [UBICACI√ìN:URL]
                    const mapMessage = `[UBICACI√ìN:${googleMapsUrl}]`;

                    // 3. Enviar el mensaje. NOTA: La ubicaci√≥n NUNCA debe ir encriptada.
                    sendChatMessage(mapMessage, false);

                    locationButton.disabled = false;
                },
                (error) => {
                    console.error('Error al obtener la ubicaci√≥n:', error.message);
                    alert('Error al obtener la ubicaci√≥n. Por favor, revisa que los permisos de ubicaci√≥n est√©n activos.');
                    locationButton.disabled = false;
                },
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
            );
        });

        function sendChatMessage(msg, isEncrypted) {
            if (!msg.trim()) return;

            const data = {
                mensaje: msg,
                isEncrypted: isEncrypted
            };

            if (currentChatId === 1) {
                // Chat General
                data.id_usuario = myId;
                data.usuario = myName;
                socket.emit('general message', data);
            } else {
                // Chat Privado
                data.id_chat = currentChatId;
                data.id_remitente = myId;
                data.usuario_remitente = myName;
                data.id_destinatario = currentRecipientId;
                socket.emit('private message', data);
            }
        }


        // =========================================================
        // 3. MANEJO DE CHAT Y UI
        // =========================================================

        socket.on('general message', (data) => {
            if (currentChatId === 1) {
                const tipo = parseInt(data.id_usuario) === parseInt(myId) ? 'me' : 'other';
                addMessage(data.mensaje, tipo, data.usuario, data.id_mensaje);
            }
        });

        socket.on('private message', (data) => {
            if (data.id_chat === currentChatId) {
                const tipo = parseInt(data.id_usuario) === parseInt(myId) ? 'me' : 'other';
                addMessage(data.mensaje, tipo, data.usuario, data.id_mensaje);
            }
        });


        // --- 1. CARGA LA LISTA DE USUARIOS (Sin cambios) ---
        async function cargarUsuarios() {
            try {
                const res = await fetch(`${SERVER_URL}/usuarios/${myId}`);
                const usuarios = await res.json();

                const activeId = currentRecipientId || (currentChatId === 1 ? 'global' : null);

                let listHTML = `<div class="chatitem ${activeId === 'global' ? 'active' : ''}"
                                onclick="selectChat('global', 1, 'Chat Global', null)">
                                <div class="chat-info">üí¨ <strong>Chat Global</strong></div>
                                </div>`;

                usuarios.forEach(u => {
                    const isOnline = onlineUsers.includes(u.id_usuario);
                    const isActive = activeId === u.id_usuario;
                    const statusClass = isOnline ? 'status-online' : 'status-offline';

                    listHTML += `<div class="chatitem ${isActive ? 'active' : ''}"
                                onclick="selectChat('private', null, '${u.usuario}', ${u.id_usuario})">
                                <div class="chat-info">
                                    ${u.usuario}
                                </div>
                                <span class="chat-status ${statusClass}" title="${isOnline ? 'Activo' : 'Inactivo'}"></span>
                                </div>`;
                });

                chatListContainer.innerHTML = listHTML;
            } catch (err) {
                console.error('Error al cargar usuarios:', err);
            }
        }

        // --- 2. CAMBIA DE CHAT (Sin cambios) ---
        window.selectChat = async function (type, chatId, name, recipientId) {

            if (type === 'global') {
                currentChatId = 1;
                currentChatName = name;
                currentRecipientId = null;
                await cargarMensajes(currentChatId);
            }
            else if (type === 'private') {
                currentRecipientId = recipientId;
                currentChatName = name;

                try {
                    const res = await fetch(`${SERVER_URL}/chat/private`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            id_usuario_1: myId,
                            id_usuario_2: recipientId
                        })
                    });
                    const data = await res.json();

                    if (data.id_chat) {
                        currentChatId = data.id_chat;
                        await cargarMensajes(currentChatId);
                    } else {
                        throw new Error('No se pudo obtener el ID de chat privado.');
                    }
                } catch (error) {
                    console.error('Error al iniciar chat privado:', error);
                    alert('No se pudo iniciar el chat privado.');
                    return;
                }
            }

            chatTitle.textContent = currentChatName;

            // Mostrar bot√≥n solo en chat privado
            const callButton = document.getElementById('callButton');
            if (recipientId) {
                callButton.style.display = 'inline-block';
                callButton.setAttribute('data-user-id', recipientId);
            } else {
                callButton.style.display = 'none';
            }

            cargarUsuarios();
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        };

        // --- 3. CARGA LOS MENSAJES ANTERIORES DEL CHAT ACTUAL (Sin cambios) ---
        async function cargarMensajes(chatId) {
            try {
                let endpoint = (chatId === 1) ? '/mensajes/general' : `/mensajes/chat/${chatId}`;
                const res = await fetch(`${SERVER_URL}${endpoint}`);
                const mensajes = await res.json();

                messagesDiv.innerHTML = '';

                mensajes.forEach(m => {
                    const tipo = parseInt(m.id_usuario) === parseInt(myId) ? 'me' : 'other';
                    addMessage(m.mensaje, tipo, m.usuario, m.id_mensaje);
                });

                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            } catch (err) {
                console.error(`Error al cargar mensajes del chat ${chatId}:`, err);
            }
        }

        // --- loadFileContent (Sin cambios) ---
        async function loadFileContent(bubble, id_mensaje) {
            try {
                const res = await fetch(`${SERVER_URL}/archivo/${id_mensaje}`);
                if (!res.ok) throw new Error('Metadata no encontrada');

                const fileData = await res.json();
                const tipoArchivo = fileData.tipo;

                bubble.innerHTML = '';

                if (tipoArchivo === 'imagen') {
                    const img = document.createElement('img');
                    img.src = `${SERVER_URL}${fileData.ruta_archivo}`;
                    img.style.maxWidth = '250px';
                    img.style.maxHeight = '250px';
                    img.style.display = 'block';
                    img.style.borderRadius = '8px';
                    bubble.appendChild(img);
                } else {
                    const link = document.createElement('a');
                    link.href = `${SERVER_URL}${fileData.ruta_archivo}`;
                    link.textContent = `Descargar: ${fileData.nombre_original}`;
                    link.download = fileData.nombre_original;
                    link.target = '_blank';
                    link.style.color = 'white';
                    link.style.textDecoration = 'underline';

                    bubble.innerHTML = 'üìé Archivo: ';
                    bubble.appendChild(link);
                }
            } catch (e) {
                console.error('Error al cargar archivo:', e);
                bubble.innerHTML = '‚ùå [Error al cargar archivo]';
            }
        }

        // --- addMessage (Manejo de UBICACI√ìN CORREGIDO) ---
        function addMessage(msg, tipo, usuario, id_mensaje) {
            const wrapper = document.createElement('div');
            wrapper.classList.add('message-wrapper', tipo);

            if (tipo === 'other' || currentChatId !== 1) {
                const userTag = document.createElement('span');
                userTag.classList.add('message-username');
                userTag.textContent = usuario;
                wrapper.appendChild(userTag);
            }

            const bubble = document.createElement('div');
            bubble.classList.add('message-bubble');

            const isFilePlaceholder = msg && msg.startsWith('[ARCHIVO:') && id_mensaje;
            const isLocationPlaceholder = msg && msg.startsWith('[UBICACI√ìN:');

            if (isFilePlaceholder) {
                bubble.textContent = 'Cargando archivo...';
                loadFileContent(bubble, id_mensaje);
            } else if (isLocationPlaceholder) {
                // 1. Obtener la URL directamente del placeholder: [UBICACI√ìN:URL_DE_MAPS]
                const urlMatch = msg.match(/^\[UBICACI√ìN:(.*)\]$/);

                if (urlMatch && urlMatch[1]) {
                    const mapLink = urlMatch[1];

                    // 2. Insertar el contenido HTML para mostrar el enlace
                    bubble.innerHTML = `
                        üìç <strong>Ubicaci√≥n Compartida</strong>
                        <br>
                        <a href="${mapLink}" target="_blank" style="color: var(--color-text-main); text-decoration: underline;">Ver en Google Maps</a>
                    `;
                } else {
                    bubble.textContent = 'üìç [Ubicaci√≥n inv√°lida]';
                }
            } else {
                bubble.textContent = msg;
            }

            wrapper.appendChild(bubble);
            messagesDiv.appendChild(wrapper);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // =========================================================
        // ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† MANEJO DE ENVIOS (Texto y Archivo)
        // =========================================================

        // --- ENV√çO DE TEXTO (Sin cambios) ---
        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const msg = chatInput.value.trim();
            if (!msg) return;

            sendChatMessage(msg, encryptionToggle.checked);
            chatInput.value = '';
        });

        // --- ENV√çO DE ARCHIVO (Sin cambios) ---
        filePickerButton.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', async (e) => {
            const archivo = e.target.files[0];
            if (!archivo) return;

            if (currentChatId === null) {
                alert("Selecciona un chat primero.");
                return;
            }

            if (archivo.size > MAX_FILE_SIZE) {
                alert(`El archivo es demasiado grande (m√°ximo ${MAX_FILE_SIZE / 1024 / 1024}MB).`);
                return;
            }

            const formData = new FormData();
            formData.append('archivo', archivo);
            formData.append('id_chat', currentChatId);
            formData.append('id_usuario', myId);
            formData.append('usuario', myName);
            formData.append('tipo_chat', currentRecipientId === null ? 'general' : 'private');
            formData.append('id_destinatario', currentRecipientId || '');
            formData.append('isEncrypted', encryptionToggle.checked);

            try {
                const res = await fetch(`${SERVER_URL}/upload`, {
                    method: 'POST',
                    body: formData,
                });

                if (!res.ok) throw new Error(`Error ${res.status} al subir archivo`);

                console.log('Archivo subido, esperando notificaci√≥n de Socket.IO...');
                fileInput.value = '';

            } catch (error) {
                console.error('Error de subida:', error);
                alert('Fallo al subir el archivo. Revisa la consola del servidor.');
            }
        });

        // --- Iniciar llamada ---
        callButton.addEventListener('click', () => {
            const targetUserId = callButton.getAttribute('data-user-id');
            if (!targetUserId) return;

            // 1. CRUCIAL: Guardar el ID del usuario llamado y marcar que SOY EL LLAMADOR
            sessionStorage.setItem("remoteUserId", targetUserId);
            sessionStorage.setItem("isCaller", 'true'); // <-- Nuevo

            console.log("üìû Enviando llamada a:", targetUserId);
            socket.emit('call:user', {
                from: myId,
                fromName: myName,
                to: targetUserId
            });
            // *Aqu√≠ podr√≠as mostrar un modal de "Esperando respuesta..."*
        });

        // --- Cuando me llaman ---
        socket.on('call:incoming', (data) => {
            console.log("üìû Llamada entrante:", data);
            const modal = document.getElementById('callModal');
            const callText = document.getElementById('callText');

            callText.textContent = `${data.fromName} te est√° llamando...`;
            modal.style.display = 'flex';

            // chatsito.html - Dentro de socket.on('call:incoming', ...)

            document.getElementById('acceptCall').onclick = () => {
                modal.style.display = 'none';
                socket.emit('call:accepted', { ...data, acceptedBy: myId });

                // 1. CRUCIAL: Guardar el ID del llamador (data.from) y marcar que NO soy el llamador
                sessionStorage.setItem("remoteUserId", data.from);
                sessionStorage.setItem("isCaller", 'false'); // <-- Nuevo

                window.location.href = "Videollamada.html";
            };


            document.getElementById('rejectCall').onclick = () => {
                modal.style.display = 'none';
                socket.emit('call:rejected', { ...data, rejectedBy: myId });
            };
        });

        socket.on('call:accepted', (data) => {
            alert(`El usuario acept√≥ la llamada.`);
            // El remoteUserId (targetUserId) y isCaller ya fueron establecidos en el evento 'click'
            // No es necesario reasignar 'remoteUserId' aqu√≠, solo nos aseguramos de que 'isCaller' est√© correcto (ya se hizo en el click).
            window.location.href = "Videollamada.html";
        });

        socket.on('call:rejected', (data) => {
            alert(`El usuario rechaz√≥ la llamada.`);
        });


        // =========================================================
        // ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† INICIALIZACI√ìN (Sin cambios)
        // =========================================================
        document.addEventListener('DOMContentLoaded', () => {
            cargarUsuarios();
            cargarMensajes(currentChatId);
        });

    </script>

    <div id="callModal" class="modal" style="display:none;">
        <div class="modal-content">
            <p id="callText"></p>
            <button id="acceptCall">Aceptar</button>
            <button id="rejectCall">Rechazar</button>
        </div>
    </div>


</body>

</html>