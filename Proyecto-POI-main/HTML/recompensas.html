<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recompensas | QuinielaZo</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@200&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../CSS/Styles.css">
    <style>
        /* Estilos extra para diferenciar completadas */
        .tarea-item.done {
            border-left: 4px solid #4CAF50;
            opacity: 0.8;
        }
        .insignia-box {
            position: relative;
            background-size: cover;
            background-position: center;
        }
        .insignia-locked {
            filter: grayscale(100%);
            opacity: 0.5;
        }
        .insignia-obtained {
            border: 2px solid #ffd700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        /* --- Tooltip Mejorado --- */
        .insignia-tooltip {
            position: absolute;
            bottom: 115%; /* Lo colocamos ARRIBA de la insignia */
            left: 50%;
            transform: translateX(-50%) scale(0.8); /* Inicia un poco m치s peque침o */
            
            /* Estilo visual */
            background: rgba(20, 20, 20, 0.95); /* Fondo casi negro */
            color: #ffd700; /* Texto Dorado */
            border: 1px solid rgba(255, 215, 0, 0.3); /* Borde dorado sutil */
            padding: 8px 14px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5); /* Sombra elegante */
            
            /* Tipograf칤a */
            font-family: 'Poppins', sans-serif;
            font-size: 0.85rem;
            font-weight: 500;
            white-space: nowrap;
            letter-spacing: 0.5px;
            
            /* Animaci칩n */
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55); /* Efecto "rebote" suave */
            z-index: 100;
            pointer-events: none; /* Evita que el tooltip estorbe al mouse */
        }

        /* Triangulito (flecha) que apunta hacia abajo */
        .insignia-tooltip::after {
            content: '';
            position: absolute;
            top: 100%; /* Justo debajo del tooltip */
            left: 50%;
            margin-left: -6px;
            border-width: 6px;
            border-style: solid;
            border-color: rgba(20, 20, 20, 0.95) transparent transparent transparent;
        }

        /* Estado Hover (Cuando pasas el mouse) */
        .insignia-box:hover .insignia-tooltip {
            opacity: 1;
            visibility: visible;
            bottom: 125%; /* Se eleva un poquito al aparecer */
            transform: translateX(-50%) scale(1); /* Crece a su tama침o normal */
        }
    </style>
</head>
<body>
<header>
        <div class="head">
            <div class="logo">
                <a href="index.html">
                    <img src="../Resources/Imagenes/QuinielazoLogo.png" alt="logo">
                </a>
            </div>
            <div class="navbar">
                <a href="QuinielaZo.html">Torneo</a>
                <a href="chatsito.html">Chat</a>
                <a href="recompensas.html">Recompensas</a>
                <a href="Novedades.html">Novedades</a>
                <a href="perfil.html">Perfil</a>
            </div>
        </div>
    </header>

    <main>
        <section class="recompensas-section">
            <h2 class="recompensas-title">Mis Recompensas</h2>
            <div class="recompensas-card">
                
                <div class="recompensas-tabs">
                    <button class="tab-btn active" id="tareasTab" onclick="showTab('tareas')">Tareas</button>
                    <button class="tab-btn" id="insigniasTab" onclick="showTab('insignias')">Insignias</button>
                </div>

                <div class="tab-content" id="tareasContent">
                    <div class="tareas-header">
                        <h3>Lista de Tareas</h3>
                    </div>
                    
                    <div class="tarea-list" id="tareaList">
                        <p style="text-align:center; color:#999;">Cargando tareas...</p>
                    </div>

                    <div class="progreso-box">
                        <div class="progreso-bar">
                            <div class="progreso-bar-inner" id="progresoBar"></div>
                        </div>
                        <span id="progresoTexto">0/0 tareas completadas</span>
                    </div>
                </div>

                <div class="tab-content" id="insigniasContent" style="display:none;">
                    <div class="insignias-grid" id="insigniasGrid">
                        <p style="text-align:center; color:#999;">Cargando insignias...</p>
                    </div>
                    <div class="insignias-leyenda">
                        춰Participa en las quinielas y completa tareas para desbloquear nuevas insignias!
                    </div>
                </div>

            </div>
        </section>
    </main>

    <footer>
        <div class="footerLinks">
            <a href="#">Contacto</a>
            <a href="#">Aviso de Privacidad</a>
            <a href="#">T칠rminos y Condiciones</a>
        </div>
        <div class="copyright">
            <p>&copy; 2026 QuinielaZo. Todos los derechos reservados.</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const userId = localStorage.getItem('userId');
            if (!userId) {
                alert("Inicia sesi칩n para ver tus recompensas.");
                window.location.href = 'inicio.html';
                return;
            }

            // Referencias DOM
            const tareaList = document.getElementById('tareaList');
            const insigniasGrid = document.getElementById('insigniasGrid');
            const progresoBar = document.getElementById('progresoBar');
            const progresoTexto = document.getElementById('progresoTexto');

            // Funciones de Tabs
            window.showTab = (tab) => {
                document.getElementById('tareasContent').style.display = (tab === 'tareas') ? 'block' : 'none';
                document.getElementById('insigniasContent').style.display = (tab === 'insignias') ? 'block' : 'none';
                document.getElementById('tareasTab').classList.toggle('active', tab === 'tareas');
                document.getElementById('insigniasTab').classList.toggle('active', tab === 'insignias');
            };

            // 1. CARGAR TAREAS
            async function loadTasks() {
                try {
                    const res = await fetch(`/api/tasks/user/${userId}`);
                    const tasks = await res.json();

                    tareaList.innerHTML = '';
                    let completedCount = 0;

                    if(tasks.length === 0) {
                        tareaList.innerHTML = '<p style="text-align:center;">No hay tareas disponibles.</p>';
                        updateProgress(0, 0);
                        return;
                    }

                    tasks.forEach(t => {
                        const isDone = t.completada_por_usuario === 1;
                        if(isDone) completedCount++;

                        const div = document.createElement('div');
                        div.className = `tarea-item ${isDone ? 'done' : ''}`;
                        
                        // El checkbox solo se puede marcar si no est치 hecho. Si ya est치 hecho, se deshabilita.
                        const checkboxHtml = `<input type="checkbox" class="tarea-checkbox" 
                                              ${isDone ? 'checked disabled' : ''} 
                                              onchange="completeTask(${t.id_tarea}, this)">`;

                        div.innerHTML = `
                            ${checkboxHtml}
                            <div class="tarea-desc">
                                <strong>${t.titulo}</strong>
                                <p>${t.descripcion}</p>
                            </div>
                            <span class="tarea-status ${isDone ? 'completado' : ''}">
                                ${isDone ? 'Completado' : 'Pendiente'}
                            </span>
                        `;
                        tareaList.appendChild(div);
                    });

                    updateProgress(completedCount, tasks.length);

                } catch(err) {
                    console.error(err);
                    tareaList.innerHTML = '<p style="color:red;">Error al cargar tareas.</p>';
                }
            }

            // 2. COMPLETAR TAREA
            window.completeTask = async (idTarea, checkbox) => {
                if(!confirm("쯄arcar esta tarea como completada?")) {
                    checkbox.checked = false;
                    return;
                }

                try {
                    const res = await fetch('/api/tasks/complete', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ id_usuario: userId, id_tarea: idTarea })
                    });

                    if(res.ok) {
                        // Recargar la lista para actualizar estilos y barra
                        loadTasks(); 
                    } else {
                        alert("Error al completar tarea.");
                        checkbox.checked = false;
                    }
                } catch(err) {
                    console.error(err);
                    checkbox.checked = false;
                }
            };

            function updateProgress(done, total) {
                const pct = total === 0 ? 0 : (done / total) * 100;
                progresoBar.style.width = `${pct}%`;
                progresoTexto.textContent = `${done}/${total} tareas completadas`;
            }

            // 3. CARGAR INSIGNIAS
            async function loadBadges() {
                try {
                    const res = await fetch(`/api/badges/user/${userId}`);
                    const badges = await res.json();

                    insigniasGrid.innerHTML = '';

                    if(badges.length === 0) {
                        insigniasGrid.innerHTML = '<p>No hay insignias configuradas.</p>';
                        return;
                    }

                    badges.forEach(b => {
                        // La propiedad "obtenida" ahora viene calculada desde el servidor (por puntos)
                        const hasIt = b.obtenida === 1;
                        const div = document.createElement('div');
                        // Clase visual si la tiene o no
                        const lockClass = hasIt ? 'insignia-obtained' : 'insignia-locked';
                        
                        // Imagen de fondo (la URL de la insignia o una por defecto)
                        // Usamos un div con background-image para centrarlo bonito
                        div.className = `insignia-box ${lockClass}`;
                        div.style.backgroundImage = `url('${b.imagen_url}')`;
                        
                        // Si la imagen falla (est치 vac칤a), mostramos un texto
                        if(!b.imagen_url) div.innerHTML = '<span class="insignia-cruz">游끥</span>';

                        // Tooltip con el nombre
                        div.innerHTML += `<div class="insignia-tooltip">${b.nombre} (${b.precio_puntos} pts)</div>`;

                        insigniasGrid.appendChild(div);
                    });

                } catch(err) {
                    console.error(err);
                }
            }

            // Inicializaci칩n
            loadTasks();
            loadBadges();
        });
    </script>
</body>
</html>