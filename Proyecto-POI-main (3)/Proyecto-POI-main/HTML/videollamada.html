<!DOCTYPE html>
<html lang="es">

<head>
    Â  Â 
    <meta charset="UTF-8">
    Â  Â 
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    Â  Â  <title>QuinielaZo - Videollamada</title>
    Â  Â 
    <link rel="stylesheet" href="../CSS/Styles.css">
    Â  Â  <style>
        /* Estilos bÃ¡sicos para la videollamada */
        #videoContainer {
            display: flex;
            justify-content: center;
            background-color: #222;
            height: 80vh;
            position: relative;
            overflow: hidden;
        }

        #remoteVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: black;
        }

        #localVideo {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 250px;
            height: 180px;
            z-index: 10;
            border: 4px solid white;
            border-radius: 8px;
            transform: scaleX(-1);
            /* Reflejo horizontal para verse natural */
        }

        .controls {
            text-align: center;
            padding: 15px;
        }

        .controls button {
            padding: 10px 20px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    Â  Â  <header>
        Â  Â  Â  Â  <div class="head">
            Â  Â  Â  Â  Â  Â  <div class="logo"><a href="index.html"><img src="../Resources/Imagenes/QuinielazoLogo.png"
                        alt="logo"></a>
                Â  Â  Â  Â  Â  Â  </div>
            Â  Â  Â  Â  Â  Â  <div class="navbar">
                Â  Â  Â  Â  Â  Â  Â  Â  <span style="color: white;">ðŸŽ¥ Videollamada</span>
                Â  Â  Â  Â  Â  Â  </div>
            Â  Â  Â  Â  </div>
        Â  Â  </header>

    Â  Â  <section class="screen" id="videocall">
        Â  Â  Â  Â  <div id="videoContainer">
            Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <video id="remoteVideo" autoplay playsinline></video>
            Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <video id="localVideo" autoplay muted playsinline></video>
            Â  Â  Â  Â  </div>

        Â  Â  Â  Â  <div class="controls">
            Â  Â  Â  Â  Â  Â  <button id="endCallButton">Colgar Llamada ðŸ›‘</button>
            Â  Â  Â  Â  </div>
        Â  Â  </section>

    Â  Â  <footer>
        Â  Â  Â  Â  <div class="copyright">
            Â  Â  Â  Â  Â  Â  <p>Â© 2026 QuinielaZo. Todos los derechos reservados.</p>
            Â  Â  Â  Â  </div>
        Â  Â  </footer>

    Â  Â 
    <script src="/socket.io/socket.io.js"></script>
    Â  Â 
    <script type="module">
        // videollamada.html - Dentro del <script type="module">

        const IP_LOCAL = "192.168.100.73";
        const SERVER_URL = window.location.hostname === "localhost"
            ? "http://localhost:3000"
            : `http://${IP_LOCAL}:3000`;

        const socket = io(SERVER_URL);
        const myId = localStorage.getItem('userId');

        // Elementos de video
        const localVideo = document.getElementById("localVideo");
        const remoteVideo = document.getElementById("remoteVideo");
        const endCallButton = document.getElementById("endCallButton");

        let localStream;
        let peerConnection;

        // Obtener datos cruciales de la sesiÃ³n
        let remoteUserId = sessionStorage.getItem("remoteUserId");
        let isCaller = sessionStorage.getItem("isCaller") === 'true';

        // Servidores ICE
        const iceServers = {
            iceServers: [
                { urls: "stun:stun.l.google.com:19302" }
            ]
        };

        // ----------------- FUNCIONES CORE WEBRTC -----------------

        async function startLocalStream() {
            try {
                console.log("ðŸŽ¥ Obteniendo stream local...");
                // Solicitar video y audio
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localVideo.srcObject = localStream;
                return true;
            } catch (error) {
                console.error("âŒ Error al acceder a la cÃ¡mara/micrÃ³fono:", error);
                alert("Necesitas permiso para usar la cÃ¡mara y el micrÃ³fono. Colgando llamada.");
                endCall();
                return false;
            }
        }

        function createPeerConnection() {
            console.log("ðŸ›  Creando RTCPeerConnection...");
            peerConnection = new RTCPeerConnection(iceServers);

            // 1. Agregar tracks locales
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });

            // 2. Manejar la recepciÃ³n de tracks remotos
            peerConnection.ontrack = (event) => {
                console.log("ðŸ“º Recibiendo video remoto");
                // Asignar el primer stream a la etiqueta de video remoto
                if (remoteVideo.srcObject !== event.streams[0]) {
                    remoteVideo.srcObject = event.streams[0];
                }
            };

            // 3. Manejar el envÃ­o de candidatos ICE para NAT Traversal
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    console.log("ðŸ“¡ Enviando ICE");
                    // Usamos el socket: 'call:ice-candidate' (ya definido en index.js)
                    socket.emit("call:ice-candidate", {
                        to: remoteUserId,
                        candidate: event.candidate
                    });
                }
            };
        }

        // Llamador: Crea Offer y lo envÃ­a
        async function startWebRTCCall() {
            console.log("ðŸ“ž Iniciando WebRTC como LLAMADOR (OFFER)...");

            if (await startLocalStream()) {
                createPeerConnection();

                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);

                socket.emit("call:offer", { to: remoteUserId, offer });
            }
        }

        // ----------------- ESCUCHA DE SOCKETS (SEÃ‘ALIZACIÃ“N) -----------------

        // Receptor: Recibe Offer y responde con Answer
        socket.on("call:offer", async ({ from, offer }) => {
            // Nos aseguramos de que la oferta sea del usuario que aceptamos.
            if (from != remoteUserId) return;

            console.log("ðŸ“ž RecibÃ­ una OFERTA de:", from);

            // El receptor ya iniciÃ³ su stream en el window.onload
            createPeerConnection();

            await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));

            // Crear y enviar la respuesta (Answer)
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);

            // Usamos el socket: 'call:answer' (ya definido en index.js)
            socket.emit("call:answer", { to: remoteUserId, answer });
        });

        // Llamador: Recibe Answer
        socket.on("call:answer", async ({ answer }) => {
            console.log("ðŸ“© RecibÃ­ respuesta (answer)");
            await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
        });

        // Ambos: Reciben ICE candidate
        socket.on("call:ice-candidate", async ({ candidate }) => {
            if (candidate && peerConnection) {
                console.log("ðŸ“¡ RecibÃ­ ICE remoto");
                try {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                } catch (e) {
                    console.error("Error aÃ±adiendo ICE candidate:", e);
                }
            }
        });


        // ----------------- FUNCIÃ“N DE COLGAR -----------------

        function endCall() {
            console.log("ðŸ”š Colgando llamada y limpiando recursos.");

            // 1. Detener tracks de la cÃ¡mara y micrÃ³fono
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }

            // 2. Cerrar la conexiÃ³n Peer
            if (peerConnection) {
                peerConnection.close();
            }

            // 3. Notificar al otro usuario que colgamos (opcional, pero Ãºtil)
            // socket.emit('call:ended', { to: remoteUserId }); 

            // 4. Limpiar la sesiÃ³n y redirigir
            sessionStorage.removeItem("remoteUserId");
            sessionStorage.removeItem("isCaller");
            window.location.href = '/chat';
        }


        // ----------------- INICIO DE LA PÃGINA -----------------

        document.addEventListener('DOMContentLoaded', async () => {
            if (!myId || !remoteUserId) {
                alert("Error: No se encontrÃ³ la informaciÃ³n de la videollamada.");
                window.location.href = '/chat';
                return;
            }

            // 1. Conectar mi ID al socket para la seÃ±alizaciÃ³n
            socket.emit('user connected', myId);

            // 2. LÃ³gica de inicio de WebRTC
            if (isCaller) {
                // Si soy el llamador, inicio el proceso WebRTC (Offer)
                startWebRTCCall();
            } else {
                // Si soy el receptor, solo inicio mi stream y espero el Offer
                await startLocalStream();
            }

            // 3. BotÃ³n para colgar
            endCallButton.addEventListener('click', endCall);
        });

        // Limpiar la llamada si el usuario sale o recarga la pÃ¡gina
        window.addEventListener('beforeunload', endCall);
    </script>
</body>

</html>